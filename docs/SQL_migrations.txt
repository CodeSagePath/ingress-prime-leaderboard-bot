CREATE TABLE users (
    id INTEGER PRIMARY KEY,
    tg_user_id BIGINT NOT NULL,
    agent_name TEXT NOT NULL,
    faction TEXT NOT NULL,
    profile_url TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT users_faction_check CHECK (faction IN ('ENL', 'RES')),
    CONSTRAINT users_tg_user_unique UNIQUE (tg_user_id),
    CONSTRAINT users_agent_name_unique UNIQUE (agent_name),
    CONSTRAINT users_tg_agent_unique UNIQUE (tg_user_id, agent_name)
);

CREATE TABLE groups (
    id INTEGER PRIMARY KEY,
    chat_id BIGINT NOT NULL,
    title TEXT NOT NULL,
    locale TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT groups_chat_unique UNIQUE (chat_id)
);

CREATE TABLE submissions (
    id INTEGER PRIMARY KEY,
    user_id INTEGER NOT NULL,
    group_id INTEGER,
    metric_type TEXT NOT NULL,
    metric_value BIGINT NOT NULL,
    payload TEXT,
    submitted_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT submissions_user_fk FOREIGN KEY (user_id) REFERENCES users (id) ON DELETE CASCADE,
    CONSTRAINT submissions_group_fk FOREIGN KEY (group_id) REFERENCES groups (id) ON DELETE SET NULL,
    CONSTRAINT submissions_unique_entry UNIQUE (user_id, metric_type, submitted_at)
);
