version: '3.8'

services:
  # Main Bot Application
  bot:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ingress-bot
    restart: unless-stopped
    environment:
      # Environment
      - ENVIRONMENT=production
      - TZ=UTC

      # Core Bot Configuration
      - BOT_TOKEN=${BOT_TOKEN}
      - BOT_NAME=${BOT_NAME:-Ingress Prime Leaderboard}
      - BOT_DESCRIPTION=${BOT_DESCRIPTION:-Track your Ingress Prime stats and compete with other agents!}
      - ADMIN_USER_IDS=${ADMIN_USER_IDS}

      # Database Configuration
      - DATABASE_URL=${DATABASE_URL:-sqlite+aiosqlite:///./data/bot.db}
      - DB_POOL_SIZE=${DB_POOL_SIZE:-10}
      - DB_MAX_OVERFLOW=${DB_MAX_OVERFLOW:-20}
      - DB_POOL_TIMEOUT=${DB_POOL_TIMEOUT:-30}
      - DB_POOL_RECYCLE=${DB_POOL_RECYCLE:-3600}
      - DB_POOL_PRE_PING=${DB_POOL_PRE_PING:-true}

      # Redis Configuration
      - REDIS_URL=redis://redis:6379/0
      - REDIS_MAX_CONNECTIONS=${REDIS_MAX_CONNECTIONS:-20}
      - REDIS_RETRY_ON_TIMEOUT=${REDIS_RETRY_ON_TIMEOUT:-true}
      - REDIS_HEALTH_CHECK_INTERVAL=${REDIS_HEALTH_CHECK_INTERVAL:-30}

      # Server Configuration
      - SERVER_HOST=0.0.0.0
      - SERVER_PORT=${SERVER_PORT:-8080}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - MAX_CONNECTIONS=${MAX_CONNECTIONS:-1000}

      # Security Configuration
      - SECURITY_ADMIN_TOKEN=${SECURITY_ADMIN_TOKEN}
      - RATE_LIMIT_ENABLED=${RATE_LIMIT_ENABLED:-true}
      - RATE_LIMIT_PER_MINUTE=${RATE_LIMIT_PER_MINUTE:-30}
      - REQUEST_TIMEOUT=${REQUEST_TIMEOUT:-30}

      # Monitoring Configuration
      - HEALTH_CHECK_ENABLED=${HEALTH_CHECK_ENABLED:-true}
      - HEALTH_CHECK_PATH=${HEALTH_CHECK_PATH:-/health}
      - METRICS_ENABLED=${METRICS_ENABLED:-false}
      - LOG_TO_FILE=${LOG_TO_FILE:-false}

      # Dashboard Configuration
      - DASHBOARD_ENABLED=${DASHBOARD_ENABLED:-true}
      - DASHBOARD_HOST=0.0.0.0
      - DASHBOARD_PORT=${DASHBOARD_PORT:-8000}
      - DASHBOARD_ADMIN_TOKEN=${DASHBOARD_ADMIN_TOKEN}

      # Bot Settings
      - LEADERBOARD_SIZE=${LEADERBOARD_SIZE:-10}
      - TEXT_ONLY_MODE=${TEXT_ONLY_MODE:-false}
      - AUTODELETE_ENABLED=${AUTODELETE_ENABLED:-true}
      - AUTODELETE_DELAY_SECONDS=${AUTODELETE_DELAY_SECONDS:-300}
      - GROUP_MESSAGE_RETENTION_MINUTES=${GROUP_MESSAGE_RETENTION_MINUTES:-60}

      # Backup Configuration
      - BACKUP_ENABLED=${BACKUP_ENABLED:-false}
      - BACKUP_RCLONE_REMOTE=${BACKUP_RCLONE_REMOTE:-}
      - BACKUP_DESTINATION_PATH=${BACKUP_DESTINATION_PATH:-ingress-bot-backups}
      - BACKUP_SCHEDULE=${BACKUP_SCHEDULE:-daily}
      - BACKUP_RETENTION_COUNT=${BACKUP_RETENTION_COUNT:-7}
      - BACKUP_COMPRESS=${BACKUP_COMPRESS:-true}

      # Performance Settings
      - CACHE_TTL_SECONDS=${CACHE_TTL_SECONDS:-300}
      - MAX_RETRIES=${MAX_RETRIES:-3}
      - RETRY_DELAY=${RETRY_DELAY:-1.0}

    ports:
      - "${SERVER_PORT:-8080}:${SERVER_PORT:-8080}"
      - "${DASHBOARD_PORT:-8000}:${DASHBOARD_PORT:-8000}"

    volumes:
      # Persistent data volumes
      - bot_data:/app/data
      - bot_logs:/app/logs

      # Backup volume (if using local backups)
      - bot_backups:/app/backups

    depends_on:
      - redis

    networks:
      - bot_network

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${SERVER_PORT:-8080}${HEALTH_CHECK_PATH:-/health}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Redis Service
  redis:
    image: redis:7-alpine
    container_name: ingress-bot-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru

    ports:
      - "6379:6379"

    volumes:
      - redis_data:/data

    networks:
      - bot_network

    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  # Optional: PostgreSQL Database (for production use)
  postgres:
    image: postgres:15-alpine
    container_name: ingress-bot-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-ingress_bot}
      - POSTGRES_USER=${POSTGRES_USER:-bot_user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}

    ports:
      - "${POSTGRES_PORT:-5432}:5432"

    volumes:
      - postgres_data:/var/lib/postgresql/data

    networks:
      - bot_network

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-bot_user} -d ${POSTGRES_DB:-ingress_bot}"]
      interval: 10s
      timeout: 5s
      retries: 5

    # Only start if POSTGRES_PASSWORD is set
    profiles:
      - postgres

  # Optional: Nginx Reverse Proxy (for production)
  nginx:
    image: nginx:alpine
    container_name: ingress-bot-nginx
    restart: unless-stopped

    ports:
      - "80:80"
      - "443:443"

    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - nginx_logs:/var/log/nginx

    depends_on:
      - bot

    networks:
      - bot_network

    # Only start with nginx profile
    profiles:
      - nginx

# Network Configuration
networks:
  bot_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# Persistent Volumes
volumes:
  bot_data:
    driver: local

  bot_logs:
    driver: local

  bot_backups:
    driver: local

  redis_data:
    driver: local

  postgres_data:
    driver: local

  nginx_logs:
    driver: local