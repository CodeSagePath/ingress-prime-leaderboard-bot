CREATE TABLE users (
    id INTEGER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    tg_user_id BIGINT NOT NULL,
    agent_name VARCHAR(255) NOT NULL,
    faction VARCHAR(3) NOT NULL,
    verified BOOLEAN NOT NULL DEFAULT FALSE,
    verification_method VARCHAR(64),
    extra JSONB,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT users_faction_check CHECK (faction IN ('ENL', 'RES'))
);

CREATE UNIQUE INDEX idx_users_tg_user_id ON users (tg_user_id);

CREATE TABLE stats (
    id INTEGER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES users (id) ON DELETE CASCADE,
    submitted_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    ap BIGINT,
    km_walked DOUBLE PRECISION,
    trekker INTEGER,
    scout INTEGER,
    reclaimer INTEGER,
    recharger INTEGER,
    other JSONB,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_stats_user_id ON stats (user_id);

CREATE TABLE leaderboard_cache (
    id INTEGER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    category VARCHAR(64) NOT NULL,
    faction VARCHAR(3) NOT NULL,
    snapshot_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    payload JSONB NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT leaderboard_cache_category_faction_key UNIQUE (category, faction),
    CONSTRAINT leaderboard_cache_faction_check CHECK (faction IN ('ENL', 'RES'))
);

CREATE TABLE groups (
    chat_id BIGINT PRIMARY KEY,
    autodelete BOOLEAN NOT NULL DEFAULT TRUE,
    autodelete_delay_seconds INTEGER NOT NULL DEFAULT 300,
    allowed_categories JSONB NOT NULL DEFAULT '[]'::jsonb,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE pending_deletions (
    id INTEGER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    chat_id BIGINT NOT NULL,
    message_id INTEGER NOT NULL,
    confirmation_message_id INTEGER,
    run_at TIMESTAMPTZ NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT pending_deletions_unique_message UNIQUE (chat_id, message_id)
);

CREATE TABLE audit_logs (
    id INTEGER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
    actor_user_id INTEGER REFERENCES users (id) ON DELETE SET NULL,
    action VARCHAR(64) NOT NULL,
    target VARCHAR(255),
    data JSONB,
    created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);
